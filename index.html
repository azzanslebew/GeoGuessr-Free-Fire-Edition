<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoGuessr FF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-gray-900 text-white font-sans min-h-screen relative p-4 sm:p-6 md:p-8">
    <!-- Map Selector Modal -->
    <div id="mapSelector"
        class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center w-full max-w-md mx-4">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-emerald-400">Pilih Peta</h2>
            <div class="grid grid-cols-2 gap-4">
                <button id="bermudaButton"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">
                    Bermuda
                </button>
                <button id="purgatoryButton"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-500 text-white font-semibold rounded-lg transition duration-200">
                    Purgatory
                </button>
                <button id="kalahariButton" disabled
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition duration-200">
                    Kalahari
                </button>
                <button id="alpineButton" disabled
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition duration-200">
                    Alpine
                </button>
                <button id="nexterraButton" disabled
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition duration-200">
                    Nexterra
                </button>
                <button id="solaraButton" disabled
                    class="px-4 py-2 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition duration-200">
                    Solara
                </button>
            </div>
        </div>
    </div>

    <!-- Clue Image Modal -->
    <div id="clueModal"
        class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="relative w-full max-w-3xl mx-4">
            <img id="clueModalImage" src="" alt="Clue" class="w-full h-auto rounded-lg shadow-lg" />
            <button id="closeClueModal"
                class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white rounded-full p-2 transition duration-200">
                âœ•
            </button>
        </div>
    </div>

    <h1 id="gameTitle" class="text-2xl sm:text-3xl md:text-4xl font-bold mb-6 text-center text-emerald-400">ðŸŽ¯ GeoGuessr
        Free Fire</h1>

    <!-- Clue Image -->
    <div class="mb-6 flex justify-center">
        <div class="relative w-full max-w-3xl">
            <img id="clueImage" src="" alt="Clue"
                class="w-full h-auto object-cover rounded-lg shadow-lg border-2 border-gray-700 transition-transform duration-200 hover:scale-105" />
            <button id="zoomClueButton"
                class="absolute bottom-2 right-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 text-sm font-semibold transition duration-200">
                Zoom
            </button>
        </div>
    </div>

    <!-- Map -->
    <div id="map"
        class="absolute bottom-4 right-4 w-[300px] h-[300px] sm:w-[350px] sm:h-[350px] md:w-[400px] md:h-[400px] rounded-lg shadow-lg border-2 border-gray-700 z-10">
    </div>

    <!-- Info and Controls -->
    <div class="mt-6 text-center max-w-md mx-auto">
        <p id="distanceDisplay" class="text-base sm:text-lg font-medium text-gray-300"></p>
        <p id="scoreDisplay" class="text-lg sm:text-xl font-bold mt-2 text-emerald-400"></p>
        <p id="roundDisplay" class="text-sm sm:text-base text-gray-400 mt-2"></p>

        <!-- Final Score Container -->
        <div id="finalScoreContainer" class="hidden flex flex-col items-center mt-6">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-emerald-400">Permainan Selesai!</h2>
            <p class="text-base sm:text-lg">Total Skor Anda: <span id="finalScore"
                    class="text-3xl sm:text-4xl font-bold text-emerald-400">0</span></p>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row justify-center gap-4">
            <button id="submitButton"
                class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-200 hidden">
                Submit Tebakan
            </button>
            <button id="nextButton"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200 hidden">
                Next Round
            </button>
            <button id="finishButton"
                class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200 hidden">
                Selesai
            </button>
            <button id="playAgainButton"
                class="px-6 py-2 bg-yellow-600 hover:bg-yellow-800 text-white font-semibold rounded-lg transition duration-200 hidden">
                Main Lagi
            </button>
        </div>
    </div>

    <script>
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -1,
            maxZoom: 4,
            zoomControl: true,
            attributionControl: false,
        });

        const bounds = [[0, 0], [1000, 1000]];

        const maps = {
            bermuda: {
                image: 'images/bermuda-map.jpg',
                title: 'ðŸŽ¯ GeoGuessr Free Fire: Bermuda Map',
                locations: [
                    { image: 'images/clues/bermuda/clue1.png', latlng: [258.8000030517578, 612.1999988555908] },
                    { image: 'images/clues/bermuda/clue2.png', latlng: [403.6500015258789, 260.8499994277954] },
                    { image: 'images/clues/bermuda/clue3.png', latlng: [648.3000030517578, 417.1999988555908] },
                    { image: 'images/clues/bermuda/clue4.png', latlng: [637.6000061035156, 831.3999977111816] },
                    { image: 'images/clues/bermuda/clue5.png', latlng: [375.3000030517578, 934.6999988555908] }
                ]
            },
            purgatory: {
                image: 'images/purgatory-map.jpg',
                title: 'ðŸŽ¯ GeoGuessr Free Fire: Purgatory Map',
                locations: [
                    { image: 'images/clues/purgatory/clue1.png', latlng: [333.6000061035156, 916] },
                    { image: 'images/clues/purgatory/clue2.png', latlng: [454.6000061035156, 653] },
                    { image: 'images/clues/purgatory/clue3.png', latlng: [880.6000061035156, 302] },
                    { image: 'images/clues/purgatory/clue4.png', latlng: [632.6000061035156, 288] },
                    { image: 'images/clues/purgatory/clue5.png', latlng: [195.8000030517578, 338.5] }
                ]
            }
        };

        let currentMap = null;
        let locations = [];
        let currentRound = 0;
        let totalScore = 0;
        let guessMarker = null;
        let answerMarker = null;
        let line = null;
        let currentGuess = null;
        let isAnswered = false;

        const clueImage = document.getElementById('clueImage');
        const clueModal = document.getElementById('clueModal');
        const clueModalImage = document.getElementById('clueModalImage');
        const zoomClueButton = document.getElementById('zoomClueButton');
        const closeClueModal = document.getElementById('closeClueModal');
        const distanceDisplay = document.getElementById('distanceDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const roundDisplay = document.getElementById('roundDisplay');
        const submitButton = document.getElementById('submitButton');
        const nextButton = document.getElementById('nextButton');
        const finishButton = document.getElementById('finishButton');
        const playAgainButton = document.getElementById('playAgainButton');
        const finalScoreContainer = document.getElementById('finalScoreContainer');
        const finalScoreElement = document.getElementById('finalScore');
        const mapSelector = document.getElementById('mapSelector');
        const bermudaButton = document.getElementById('bermudaButton');
        const purgatoryButton = document.getElementById('purgatoryButton');
        const gameTitle = document.getElementById('gameTitle');

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function resetMap() {
            if (guessMarker) {
                map.removeLayer(guessMarker);
                guessMarker = null;
            }
            if (answerMarker) {
                map.removeLayer(answerMarker);
                answerMarker = null;
            }
            if (line) {
                map.removeLayer(line);
                line = null;
            }
        }

        function startGame(mapKey) {
            currentMap = maps[mapKey];
            locations = shuffleArray([...currentMap.locations]);
            gameTitle.textContent = currentMap.title;
            mapSelector.classList.add('hidden');
            map.eachLayer(layer => map.removeLayer(layer));
            L.imageOverlay(currentMap.image, bounds).addTo(map);
            map.setMaxBounds(bounds);
            map.fitBounds(bounds);
            currentRound = 0;
            totalScore = 0;
            clueImage.classList.remove('hidden');
            startRound();
        }

        function startRound() {
            resetMap();
            currentGuess = null;
            isAnswered = false;

            const loc = locations[currentRound];
            clueImage.src = loc.image;
            clueModalImage.src = loc.image;
            clueImage.classList.remove('hidden');
            roundDisplay.textContent = `Round ${currentRound + 1} of ${locations.length}`;
            distanceDisplay.textContent = '';
            scoreDisplay.textContent = '';

            submitButton.classList.add('hidden');
            nextButton.classList.add('hidden');
            finishButton.classList.add('hidden');
            playAgainButton.classList.add('hidden');
            finalScoreContainer.classList.add('hidden');
        }

        function animateScore(targetScore) {
            let currentScore = 0;
            const increment = Math.ceil(targetScore / 100);
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                finalScoreElement.textContent = currentScore.toLocaleString();
            }, 20);
        }

        function showFinalScore() {
            finalScoreContainer.classList.remove('hidden');
            animateScore(totalScore);
            finishButton.classList.remove('hidden');
            playAgainButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            clueImage.classList.add('hidden');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function finishRound() {
            if (!currentGuess || isAnswered) {
                showNotification('Silakan pilih lokasi di peta terlebih dahulu!');
                return;
            }

            const correctLatLng = locations[currentRound].latlng;

            answerMarker = L.marker(correctLatLng, {
                icon: L.icon({
                    iconUrl: 'images/marker/answer.png',
                    iconSize: [35, 35],
                    iconAnchor: [12, 12]
                })
            }).addTo(map);

            line = L.polyline([currentGuess, correctLatLng], { color: 'deepskyblue', weight: 3 }).addTo(map);

            const distance = Math.sqrt(
                Math.pow(currentGuess[0] - correctLatLng[0], 2) +
                Math.pow(currentGuess[1] - correctLatLng[1], 2)
            );

            const maxDistance = 1000;
            const normalizedDistance = distance / maxDistance;
            const score = distance <= 20 ? 5000 : Math.max(0, Math.floor(5000 * (1 - normalizedDistance)));
            totalScore += score;

            distanceDisplay.textContent = `Jarak tebakanmu: ${Math.floor(distance)} m`;
            scoreDisplay.textContent = `Skor Ronde: ${score} | Total: ${totalScore}`;
            showNotification(`Skor Ronde: ${score}`);

            submitButton.classList.add('hidden');
            if (currentRound + 1 >= locations.length) {
                finishButton.classList.remove('hidden');
            } else {
                nextButton.classList.remove('hidden');
            }

            isAnswered = true;
            map.fitBounds([currentGuess, correctLatLng], { padding: [50, 50] });
        }

        map.on('click', function (e) {
            if (isAnswered) return;

            if (guessMarker) {
                map.removeLayer(guessMarker);
            }

            currentGuess = [e.latlng.lat, e.latlng.lng];
            guessMarker = L.marker(currentGuess, {
                icon: L.icon({
                    iconUrl: 'images/marker/guess.png',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(map);

            submitButton.classList.remove('hidden');
            showNotification('Tebakan ditempatkan! Klik Submit untuk lanjut.');
        });

        zoomClueButton.addEventListener('click', () => {
            clueModal.classList.remove('hidden');
        });

        closeClueModal.addEventListener('click', () => {
            clueModal.classList.add('hidden');
        });

        submitButton.addEventListener('click', finishRound);

        nextButton.addEventListener('click', () => {
            currentRound++;
            if (currentRound >= locations.length) {
                showFinalScore();
            } else {
                startRound();
            }
        });

        finishButton.addEventListener('click', () => {
            showFinalScore();
        });

        playAgainButton.addEventListener('click', () => {
            mapSelector.classList.remove('hidden');
            currentRound = 0;
            totalScore = 0;
            clueImage.classList.add('hidden');
        });

        bermudaButton.addEventListener('click', () => startGame('bermuda'));
        purgatoryButton.addEventListener('click', () => startGame('purgatory'));

        // Initialize with a notification
        showNotification('Pilih peta untuk memulai permainan!');
    </script>
</body>

</html>