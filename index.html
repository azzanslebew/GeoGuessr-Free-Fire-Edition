<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoGuessr FF - Duel Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
    import { getDatabase, ref, set, onValue, update, push, child, get }
      from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
    // --- KONFIGURASI FIREBASE ANDA DI SINI ---
    // GANTI DENGAN CONFIG DARI FIREBASE CONSOLE ANDA
    const firebaseConfig = {
      apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
      authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
      databaseURL: import.meta.env.VITE_FIREBASE_DATABASE_URL,
      projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
      storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
      messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
      appId: import.meta.env.VITE_FIREBASE_APP_ID,
      measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    window.db = db; // Expose to window for global access
    window.fbRefs = { ref, set, onValue, update, push, child, get };
  </script>
</head>

<body class="bg-gray-900 text-white font-sans min-h-screen relative p-4 sm:p-6 overflow-x-hidden">
  <div id="loginScreen" class="fixed inset-0 bg-gray-900 z-[60] flex flex-col items-center justify-center p-4">
    <h1 class="text-4xl font-bold text-emerald-400 mb-8">GeoGuessr FF</h1>
    <div class="bg-gray-800 p-8 rounded-xl w-full max-w-md shadow-2xl border border-gray-700">
      <label class="block text-gray-400 mb-2">Nickname</label>
      <input type="text" id="usernameInput" placeholder="Masukkan nama..."
        class="w-full p-3 rounded bg-gray-700 text-white mb-6 border border-gray-600 focus:border-emerald-500 outline-none">
      <div class="space-y-3">
        <button onclick="startSinglePlayer()"
          class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold transition">
          üë§ Single Player
        </button>
        <div class="relative flex py-2 items-center">
          <div class="flex-grow border-t border-gray-600"></div>
          <span class="flex-shrink-0 mx-4 text-gray-400">Duel Mode</span>
          <div class="flex-grow border-t border-gray-600"></div>
        </div>
        <button onclick="createRoom()"
          class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-bold transition">
          ‚öîÔ∏è Buat Room (Host)
        </button>
        <div class="flex gap-2">
          <input type="text" id="roomCodeInput" placeholder="Kode Room"
            class="flex-1 p-3 rounded bg-gray-700 border border-gray-600 uppercase">
          <button onclick="joinRoom()"
            class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold transition">
            Join
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="lobbyScreen" class="fixed inset-0 bg-gray-900 z-[55] flex flex-col items-center justify-center hidden">
    <div class="bg-gray-800 p-8 rounded-xl text-center shadow-2xl max-w-md w-full">
      <h2 class="text-2xl font-bold text-emerald-400 mb-2">Lobby Room</h2>
      <div class="bg-black bg-opacity-30 p-4 rounded mb-6">
        <p class="text-gray-400 text-sm">Kode Room:</p>
        <p id="displayRoomCode"
          class="text-4xl font-mono font-bold tracking-widest text-white select-all cursor-pointer">---</p>
      </div>
      <div class="space-y-2 mb-6 text-left">
        <p>Host: <span id="p1Name" class="text-emerald-400 font-bold">...</span></p>
        <p>Guest: <span id="p2Name" class="text-purple-400 font-bold">Menunggu...</span></p>
      </div>
      <p id="lobbyStatus" class="text-yellow-400 animate-pulse mb-4">Menunggu lawan join...</p>
      <div id="hostMapSelect" class="hidden">
        <p class="mb-2 text-sm text-gray-300">Pilih Map:</p>
        <div class="flex gap-2 justify-center">
          <button onclick="selectMapMultiplayer('bermuda')"
            class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">Bermuda</button>
          <button onclick="selectMapMultiplayer('purgatory')"
            class="px-4 py-2 bg-red-600 rounded hover:bg-red-500">Purgatory</button>
        </div>
      </div>
    </div>
  </div>
  <h1 id="gameTitle" class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 text-center text-emerald-400 pt-2">üéØ
    GeoGuessr FF</h1>
  <div id="mpScoreboard"
    class="hidden max-w-4xl mx-auto mb-4 bg-gray-800 rounded-lg p-2 flex justify-between items-center border border-gray-700">
    <div class="text-left px-4">
      <p id="mpP1Name" class="text-xs text-gray-400">Player 1</p>
      <p id="mpP1Score" class="text-xl font-bold text-emerald-400">0</p>
      <span id="mpP1Status" class="text-xs bg-gray-700 px-2 py-0.5 rounded hidden">Sudah Menebak</span>
    </div>
    <div class="text-center">
      <p class="text-xs text-gray-500">VS</p>
      <p id="mpRoundInfo" class="text-sm font-bold">Ronde 1/5</p>
    </div>
    <div class="text-right px-4">
      <p id="mpP2Name" class="text-xs text-gray-400">Player 2</p>
      <p id="mpP2Score" class="text-xl font-bold text-purple-400">0</p>
      <span id="mpP2Status" class="text-xs bg-gray-700 px-2 py-0.5 rounded hidden">Sudah Menebak</span>
    </div>
  </div>
  <div id="mapSelector" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-xl text-center">
      <h2 class="text-2xl font-bold mb-4">Pilih Peta (Single Player)</h2>
      <div class="flex gap-4">
        <button onclick="startSingleGame('bermuda')" class="px-4 py-2 bg-blue-600 rounded">Bermuda</button>
        <button onclick="startSingleGame('purgatory')" class="px-4 py-2 bg-red-600 rounded">Purgatory</button>
      </div>
    </div>
  </div>
  <div class="mb-4 flex justify-center px-0 sm:px-4">
    <div class="relative w-full max-w-3xl aspect-video bg-gray-800 rounded-lg overflow-hidden border-2 border-gray-700">
      <img id="clueImage" src="" class="w-full h-full object-cover" />
      <div id="waitingForOpponentOverlay"
        class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden">
        <p class="text-white font-bold animate-pulse">Menunggu lawan menebak...</p>
      </div>
    </div>
  </div>
  <div id="map"
    class="absolute bottom-4 right-4 w-[200px] h-[200px] sm:w-[300px] sm:h-[300px] md:w-[350px] md:h-[350px] rounded-lg shadow-lg border-2 border-gray-700 z-10 transition-all duration-300 hover:w-[350px] hover:h-[350px] hover:md:w-[450px] hover:md:h-[450px]">
  </div>
  <div class="mt-2 text-center max-w-md mx-auto relative z-20 pb-10">
    <p id="distanceDisplay" class="text-lg font-medium text-gray-300 min-h-[1.5rem]"></p>
    <div id="singlePlayerControls" class="hidden mt-4 flex justify-center gap-4">
      <button id="spSubmitBtn" class="px-6 py-2 bg-green-600 rounded hidden">Submit</button>
      <button id="spNextBtn" class="px-6 py-2 bg-blue-600 rounded hidden">Next</button>
    </div>
    <div id="multiPlayerControls" class="hidden mt-4 flex justify-center gap-4">
      <button id="mpSubmitBtn"
        class="px-6 py-2 bg-green-600 rounded font-bold shadow-lg hover:bg-green-500 transition hidden">LOCK JAWABAN
        üîí</button>
      <div id="mpWaitingMsg" class="hidden text-sm text-yellow-400 italic">Menunggu lawan...</div>
      <button id="mpNextBtn"
        class="px-6 py-2 bg-blue-600 rounded font-bold shadow-lg hover:bg-blue-500 transition hidden">LANJUT RONDE
        BERIKUTNYA ‚ñ∂</button>
    </div>
  </div>
  <script>
    // --- GAME DATA ---
    const maps = {
      bermuda: {
        image: 'images/bermuda-map.jpg', // Pastikan file ada
        title: 'Bermuda',
        locations: [
          { image: 'images/clues/bermuda/clue1.png', latlng: [258.8, 612.2] },
          { image: 'images/clues/bermuda/clue2.png', latlng: [403.6, 260.8] },
          { image: 'images/clues/bermuda/clue3.png', latlng: [648.3, 417.2] },
          { image: 'images/clues/bermuda/clue4.png', latlng: [637.6, 831.4] },
          { image: 'images/clues/bermuda/clue5.png', latlng: [375.3, 934.7] }
        ]
      },
      purgatory: {
        image: 'images/purgatory-map.jpg', // Pastikan file ada
        title: 'Purgatory',
        locations: [
          { image: 'images/clues/purgatory/clue1.png', latlng: [333.6, 916] },
          { image: 'images/clues/purgatory/clue2.png', latlng: [454.6, 653] },
          { image: 'images/clues/purgatory/clue3.png', latlng: [880.6, 302] },
          { image: 'images/clues/purgatory/clue4.png', latlng: [632.6, 288] },
          { image: 'images/clues/purgatory/clue5.png', latlng: [195.8, 338.5] }
        ]
      }
    };
    // --- MAP SETUP ---
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -1, maxZoom: 3, zoomControl: false });
    const bounds = [[0, 0], [1000, 1000]];
    let currentMapLayer = null;
    let guessMarker, answerMarker, line;
    // --- STATE ---
    let mode = 'single'; // 'single' or 'multi'
    let myName = '';
    let roomId = null;
    let isHost = false;
    let playerKey = null; // 'p1' or 'p2'
    let currentLocations = [];
    let currentRoundIndex = 0;
    let myGuess = null;
    let hasLocked = false;
    // --- DOM ELEMENTS ---
    const loginScreen = document.getElementById('loginScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const mapSelector = document.getElementById('mapSelector');
    const singleControls = document.getElementById('singlePlayerControls');
    const multiControls = document.getElementById('multiPlayerControls');
    const mpScoreboard = document.getElementById('mpScoreboard');
    // --- CORE FUNCTIONS ---
    function shuffleArray(array) {
      return array.sort(() => Math.random() - 0.5);
    }
    function resetMapMarkers() {
      if (guessMarker) map.removeLayer(guessMarker);
      if (answerMarker) map.removeLayer(answerMarker);
      if (line) map.removeLayer(line);
      guessMarker = null; answerMarker = null; line = null;
      myGuess = null;
      hasLocked = false;
    }
    function loadMapImage(mapKey) {
      if (currentMapLayer) map.removeLayer(currentMapLayer);
      currentMapLayer = L.imageOverlay(maps[mapKey].image, bounds).addTo(map);
      map.fitBounds(bounds);
    }
    // Map Click Logic
    map.on('click', (e) => {
      if (hasLocked) return;
      if (guessMarker) map.removeLayer(guessMarker);
      myGuess = [e.latlng.lat, e.latlng.lng];
      guessMarker = L.marker(myGuess).addTo(map);
      if (mode === 'single') {
        document.getElementById('spSubmitBtn').classList.remove('hidden');
      } else {
        document.getElementById('mpSubmitBtn').classList.remove('hidden');
      }
    });
    // ----------------------
    // SINGLE PLAYER LOGIC
    // ----------------------
    function startSinglePlayer() {
      const name = document.getElementById('usernameInput').value;
      if (!name) return alert("Isi nama dulu!");
      myName = name;
      mode = 'single';
      loginScreen.classList.add('hidden');
      mapSelector.classList.remove('hidden');
    }
    function startSingleGame(mapKey) {
      mapSelector.classList.add('hidden');
      singleControls.classList.remove('hidden');
      currentLocations = shuffleArray([...maps[mapKey].locations]);
      currentRoundIndex = 0;
      loadMapImage(mapKey);
      loadSingleRound();
    }
    function loadSingleRound() {
      resetMapMarkers();
      document.getElementById('spSubmitBtn').classList.add('hidden');
      document.getElementById('spNextBtn').classList.add('hidden');
      document.getElementById('clueImage').src = currentLocations[currentRoundIndex].image;
      document.getElementById('distanceDisplay').innerText = `Round ${currentRoundIndex + 1}`;
    }
    document.getElementById('spSubmitBtn').onclick = () => {
      hasLocked = true;
      const correct = currentLocations[currentRoundIndex].latlng;
      showResult(myGuess, correct);
      document.getElementById('spSubmitBtn').classList.add('hidden');
      document.getElementById('spNextBtn').classList.remove('hidden');
    };
    document.getElementById('spNextBtn').onclick = () => {
      currentRoundIndex++;
      if (currentRoundIndex >= currentLocations.length) {
        alert("Game Selesai!");
        location.reload();
      } else {
        loadSingleRound();
      }
    };
    function showResult(guess, correct) {
      answerMarker = L.marker(correct, { opacity: 0.7 }).addTo(map);
      line = L.polyline([guess, correct], { color: 'yellow' }).addTo(map);
      const dist = map.distance(guess, correct); // Leaflet simple distance
      // Simple scoring logic
      const score = Math.max(0, 5000 - Math.floor(dist * 5));
      document.getElementById('distanceDisplay').innerText = `Skor: ${score}`;
      return score;
    }
    // ----------------------
    // MULTIPLAYER LOGIC
    // ----------------------
    async function createRoom() {
      const name = document.getElementById('usernameInput').value;
      if (!name) return alert("Isi nama dulu!");
      // Generate Room Code (4 chars)
      roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
      myName = name;
      isHost = true;
      playerKey = 'p1';
      // Initial DB State
      const initialData = {
        status: 'waiting', // waiting, playing, finished
        players: {
          p1: { name: name, score: 0, guessed: false, lat: 0, lng: 0 },
          p2: { name: '', score: 0, guessed: false, lat: 0, lng: 0 }
        },
        game: {
          map: '',
          round: 0,
          locations: [] // Indexes of locations
        }
      };
      await window.fbRefs.set(window.fbRefs.ref(window.db, 'rooms/' + roomId), initialData);
      enterLobby();
    }
    async function joinRoom() {
      const name = document.getElementById('usernameInput').value;
      const code = document.getElementById('roomCodeInput').value.toUpperCase();
      if (!name || !code) return alert("Isi nama dan kode room!");
      const roomRef = window.fbRefs.ref(window.db, 'rooms/' + code);
      const snapshot = await window.fbRefs.get(roomRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        if (data.status !== 'waiting') return alert("Game sudah mulai atau penuh!");
        // Add Player 2
        await window.fbRefs.update(roomRef, {
          "players/p2": { name: name, score: 0, guessed: false, lat: 0, lng: 0 }
        });
        roomId = code;
        myName = name;
        isHost = false;
        playerKey = 'p2';
        enterLobby();
      } else {
        alert("Room tidak ditemukan!");
      }
    }
    function enterLobby() {
      loginScreen.classList.add('hidden');
      lobbyScreen.classList.remove('hidden');
      document.getElementById('displayRoomCode').innerText = roomId;
      // Listen to Room Changes
      window.fbRefs.onValue(window.fbRefs.ref(window.db, 'rooms/' + roomId), (snapshot) => {
        const data = snapshot.val();
        if (!data) return; // Room deleted
        // Update Lobby Names
        document.getElementById('p1Name').innerText = data.players.p1.name;
        document.getElementById('p2Name').innerText = data.players.p2.name || 'Menunggu...';
        // Host Logic to Start Game
        if (isHost && data.players.p2.name && data.status === 'waiting') {
          document.getElementById('lobbyStatus').innerText = "Lawan Masuk! Pilih Map untuk Mulai.";
          document.getElementById('hostMapSelect').classList.remove('hidden');
        } else if (!isHost && data.status === 'waiting' && data.players.p2.name) {
          document.getElementById('lobbyStatus').innerText = "Menunggu Host memilih map...";
        }
        // Game Started?
        if (data.status === 'playing') {
          lobbyScreen.classList.add('hidden');
          multiControls.classList.remove('hidden');
          mpScoreboard.classList.remove('hidden');
          syncGameState(data);
        }
      });
    }
    function selectMapMultiplayer(mapKey) {
      // Generate random indexes
      const locCount = maps[mapKey].locations.length;
      const indices = Array.from({ length: locCount }, (_, i) => i).sort(() => Math.random() - 0.5);
      window.fbRefs.update(window.fbRefs.ref(window.db, 'rooms/' + roomId), {
        status: 'playing',
        "game/map": mapKey,
        "game/locations": indices,
        "game/round": 0
      });
    }
    // --- MAIN MULTIPLAYER GAME LOOP ---
    let lastRoundProcessed = -1;
    function syncGameState(data) {
      const p1 = data.players.p1;
      const p2 = data.players.p2;
      const game = data.game;
      const mapKey = game.map;
      // 1. Setup Map & Images if changed
      if (!currentMapLayer) loadMapImage(mapKey);
      // 2. Scoreboard Update
      document.getElementById('mpP1Name').innerText = p1.name;
      document.getElementById('mpP2Name').innerText = p2.name;
      document.getElementById('mpP1Score').innerText = p1.score;
      document.getElementById('mpP2Score').innerText = p2.score;
      document.getElementById('mpRoundInfo').innerText = `Ronde ${game.round + 1}`;
      // Visual Status indicators
      document.getElementById('mpP1Status').classList.toggle('hidden', !p1.guessed);
      document.getElementById('mpP2Status').classList.toggle('hidden', !p2.guessed);
      // 3. New Round Logic
      if (game.round !== lastRoundProcessed) {
        lastRoundProcessed = game.round;
        resetMapMarkers();
        // Get current location image
        const locIndex = game.locations[game.round];
        const locData = maps[mapKey].locations[locIndex];
        document.getElementById('clueImage').src = locData.image;
        document.getElementById('mpSubmitBtn').classList.add('hidden');
        document.getElementById('mpNextBtn').classList.add('hidden');
        document.getElementById('waitingForOpponentOverlay').classList.add('hidden');
        document.getElementById('mpWaitingMsg').classList.add('hidden');
        map.closePopup();
      }
      // 4. End of Round Logic (Both guessed)
      if (p1.guessed && p2.guessed && !document.getElementById('mpNextBtn').classList.contains('active')) {
        // Show results
        const locIndex = game.locations[game.round];
        const correct = maps[mapKey].locations[locIndex].latlng;
        // Draw opponent marker
        const oppKey = playerKey === 'p1' ? 'p2' : 'p1';
        const oppData = data.players[oppKey];
        const oppLatLng = [oppData.lat, oppData.lng];
        // My result already drawn. Draw opponent:
        L.marker(oppLatLng, { icon: L.divIcon({ className: 'bg-transparent', html: 'üî¥' }) }).addTo(map);
        L.polyline([oppLatLng, correct], { color: 'red', dashArray: '5, 5' }).addTo(map);
        // Show Correct Answer
        answerMarker = L.marker(correct).addTo(map).bindPopup("Lokasi Asli").openPopup();
        if (isHost) {
          document.getElementById('mpNextBtn').classList.remove('hidden');
          document.getElementById('mpNextBtn').classList.add('active'); // Flag to prevent redraw
        } else {
          document.getElementById('mpWaitingMsg').innerText = "Menunggu Host lanjut...";
          document.getElementById('mpWaitingMsg').classList.remove('hidden');
        }
        document.getElementById('waitingForOpponentOverlay').classList.add('hidden');
      }
    }
    // Multiplayer Action: Submit Guess
    document.getElementById('mpSubmitBtn').onclick = () => {
      if (!myGuess) return;
      hasLocked = true;
      document.getElementById('mpSubmitBtn').classList.add('hidden');
      document.getElementById('mpWaitingMsg').classList.remove('hidden');
      // Calculate temp score
      // Need to fetch current correct location from maps
      window.fbRefs.get(window.fbRefs.ref(window.db, `rooms/${roomId}/game`)).then((snap) => {
        const game = snap.val();
        const locIndex = game.locations[game.round];
        const correct = maps[game.map].locations[locIndex].latlng;
        const dist = map.distance(myGuess, correct);
        const scoreAdd = Math.max(0, 5000 - Math.floor(dist * 5));
        // Draw my line locally immediately
        L.polyline([myGuess, correct], { color: 'deepskyblue' }).addTo(map);
        // Update DB
        const updates = {};
        updates[`players/${playerKey}/guessed`] = true;
        updates[`players/${playerKey}/lat`] = myGuess[0];
        updates[`players/${playerKey}/lng`] = myGuess[1];
        // Atomic increment not easy in simple JS, so read-write:
        // For simplicity here we assume local score calc is safe enough for casual game
        // Ideally use transaction, but let's just add to current score locally and push
        // We actually need to read the current score first to add to it properly
        window.fbRefs.get(window.fbRefs.ref(window.db, `rooms/${roomId}/players/${playerKey}/score`)).then(sSnap => {
          const currentScore = sSnap.val() || 0;
          updates[`players/${playerKey}/score`] = currentScore + scoreAdd;
          window.fbRefs.update(window.fbRefs.ref(window.db, `rooms/${roomId}`), updates);
        });
      });
      document.getElementById('waitingForOpponentOverlay').classList.remove('hidden');
    };
    // Multiplayer Action: Next Round (Host Only)
    document.getElementById('mpNextBtn').onclick = () => {
      document.getElementById('mpNextBtn').classList.remove('active');
      window.fbRefs.get(window.fbRefs.ref(window.db, `rooms/${roomId}/game`)).then((snap) => {
        const game = snap.val();
        const nextRound = game.round + 1;
        const totalRounds = maps[game.map].locations.length;
        if (nextRound >= totalRounds) {
          alert("Game Selesai! Score akhir ada di papan.");
          // Reset or Go to Lobby logic here
        } else {
          // Reset guessed flags and increment round
          const updates = {
            "game/round": nextRound,
            "players/p1/guessed": false,
            "players/p2/guessed": false
          };
          window.fbRefs.update(window.fbRefs.ref(window.db, `rooms/${roomId}`), updates);
        }
      });
    };
  </script>
</body>

</html>